<odoo>

    <!-- duplicata of the template payment.payment_confirmation_status.
        The duplication avoid to break an existing installation in stable version-->
    <template id="payment_confirmation_status">
        <div t-if="payment_tx_id and payment_tx_id.state == 'done'" class="alert alert-success alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&amp;times;</button>
            <span t-if='payment_tx_id.acquirer_id.done_msg' t-raw="payment_tx_id.acquirer_id.done_msg"/>
            <span t-if='payment_tx_id.acquirer_id.post_msg' t-raw="payment_tx_id.acquirer_id.post_msg"/>
        </div>
        <div t-if="payment_tx_id and payment_tx_id.state == 'pending'" class="alert alert-warning alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&amp;times;</button>
            <span t-if='payment_tx_id.acquirer_id.pending_msg' t-raw="payment_tx_id.acquirer_id.pending_msg"/>
            <span t-if='payment_tx_id.acquirer_id.post_msg' t-raw="payment_tx_id.acquirer_id.post_msg"/>
        </div>
        <div t-if="payment_tx_id and payment_tx_id.state == 'cancel'" class="alert alert-danger alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&amp;times;</button>
            <span t-if='payment_tx_id.acquirer_id.cancel_msg' t-raw="payment_tx_id.acquirer_id.cancel_msg"/>
        </div>
        <div t-if="payment_tx_id and payment_tx_id.state == 'error'" class="alert alert-danger alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&amp;times;</button>
            <span t-if='payment_tx_id.acquirer_id.error_msg' t-raw="payment_tx_id.acquirer_id.error_msg"/>
        </div>
        <div t-if="payment_tx_id and payment_tx_id.state == 'authorized'" class="alert alert-success alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&amp;times;</button>
            Your payment has been authorized.
            <span t-if='payment_tx_id.acquirer_id.post_msg' t-raw="payment_tx_id.acquirer_id.post_msg"/>
        </div>
    </template>


    <template id="portal_my_orders_payment" name="Payment on my orders" inherit_id="sale.portal_order_page">
        <xpath expr="//t[@name='portal_confirmation_sign']" position="after">
            <t t-if="not invoices and order.state in ('sent', 'sale') and portal_confirmation == 'pay' and order.payment_tx_id.state != 'done'" name="portal_confirmation_pay">
                <a class="btn btn-primary btn-block" data-toggle="modal" href="#portal_pay">
                    <i class="fa fa-arrow-circle-right"/> Accept &amp; Pay
                </a>
            </t>
            <t t-if="invoices and order.state in ('sale', 'done') and portal_confirmation == 'pay'">
                <a class="btn btn-primary btn-block" disabled="disabled">
                    <i class="fa fa-check-circle"/> Done
                </a>
            </t>
        </xpath>
        <xpath expr="//t[@t-call='sale.portal_order_success']" position="after">
            <div t-if="order.payment_tx_ids and not invoices and order.state in ('sent', 'sale') and portal_confirmation == 'pay' and not success and not error" class="o_sale_payment_tx_status" t-att-data-order-id="order.id">
                <t t-set="payment_tx_id" t-value="order.payment_tx_id"/>
                <t t-call="sale_payment.payment_confirmation_status"/>
            </div>
        </xpath>
    </template>

    <template id="so_confirmation_action" name="Payment on my orders" inherit_id="sale.so_confirmation_action">
        <xpath expr="//div[@id='quotation_toolbar']/a" position="after">
            <t t-if="not invoices and order.state in ('sent', 'sale') and portal_confirmation == 'pay' and order.payment_tx_id.state != 'done'" name="portal_confirmation_pay">
                <a class="btn btn-success" data-toggle="modal" data-target="#portal_pay">
                    <i class="fa fa-arrow-circle-right"/> Accept &amp; Pay
                </a>
            </t>
        </xpath>
    </template>

    <template id="payment_dialog" name="Payment Modal" inherit_id="sale.signature_dialog">
        <xpath expr="//div[@id='modalaccept']" position="after">
            <div class="row" t-if="not invoices and order.state in ('sent', 'sale') and portal_confirmation == 'pay' and portal_layout" id="pay_with">
                <div class="col-md-offset-3 col-md-6">
                    <div class="modal fade" id="portal_pay" tabindex="-1" role="dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&amp;times;</button>
                                    <h3 class="modal-title">Payment Methods</h3>
                                </div>
                                <div class="modal-body">
                                    <p>
                                        <span>I agree that by signing this proposal, I accept it on the behalf of </span>
                                        <b t-field="quotation.partner_id.commercial_partner_id"/>
                                        <span>, for an amount of </span>
                                        <b data-id="total_amount" t-field="quotation.amount_total"
                                            t-options='{"widget": "monetary", "display_currency": quotation.pricelist_id.currency_id}'/>
                                        <span>with payment terms: </span><b t-field="quotation.payment_term_id"/>.
                                    </p>
                                </div>
                                <div class="modal-footer">
                                    <div t-if="pms or s2s_acquirers or form_acquirers" id="payment_method" class="text-left col-md-13">
                                        <h3 class="mb24 mt0">Pay with</h3>
                                        <t t-call="payment.payment_tokens_list">
                                            <t t-set="mode" t-value="'payment'"/>
                                            <t t-set="partner_id" t-value="order.partner_id.id"/>
                                            <t t-set="access_token" t-value="access_token"/>
                                            <t t-set="success_url" t-value="'/my/orders/%s?%s' % (order.id, keep_query())"/>
                                            <t t-set="error_url" t-value="'/my/orders/%s?%s' % (order.id, keep_query())"/>
                                            <t t-set="callback_method" t-value="''"/>
                                            <t t-set="submit_txt" t-value="'Pay Now'"/>
                                            <t t-set="icon_class" t-value="'fa-lock'"/>
                                            <t t-set="form_action" t-value="'/pay/sale/' + str(order.id) + '/s2s_token_tx/'"/>
                                            <t t-set="prepare_tx_url" t-value="'/pay/sale/' + str(order.id) + '/form_tx/'"/>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <template id="portal_my_orders_payment_tx" name="Payment on my orders" inherit_id="sale.quotation_content">
       <xpath expr="//div[@id='invoices']" position="after">
           <t t-set="tx_ids" t-value="order.payment_tx_ids.filtered(lambda tx: tx.state in ('pending', 'authorized', 'done'))"/>
           <div t-if="tx_ids">
               <label class="col-sm-4 col-xs-4 text-right">Transactions:</label>
               <div class="col-sm-8 col-xs-8">
                   <t t-foreach="tx_ids" t-as="tx">
                       <div>
                           <span t-esc="tx.reference"/>
                           <span class="text-muted" t-field="tx.create_date"/>
                           <t t-if="tx.state == 'done'">
                               <span class="label label-success orders_label_text_align"><i class="fa fa-fw fa-check"/> Done</span>
                           </t>
                           <t t-if="tx.state != 'done'">
                               <span class="label label-info orders_label_text_align"><i class="fa fa-fw fa-clock-o"/> Waiting</span>
                               <t t-if="tx.state_message"><br /><span t-esc="tx.state_message"/></t>
                           </t>
                       </div>
                   </t>
               </div>
           </div>
       </xpath>
   </template>

    <template id="portal_order_error" name="Order error display: payment errors"
            inherit_id="sale.portal_order_error">
        <xpath expr="//t[@name='generic']" position="after">
            <t t-if="error == 'pay_sale_invalid_doc'">
                There was an error processing your payment: invalid order.
            </t>
            <t t-if="error == 'pay_sale_invalid_doc_state'">
                There was an error processing your payment: invalid order state.
            </t>
            <t t-if="error == 'pay_sale_invalid_token'">
                There was en error processing your payment: invalid credit card ID.
            </t>
            <t t-if="error == 'pay_sale_tx_amount'">
                There was an error processing your payment: transaction amount issue.<br />
                <t t-if="order.payment_tx_id">
                    <t t-esc="order.payment_tx_id.amount"/> / <t t-esc="order.amount_total"/>
                </t>
            </t>
            <t t-if="error == 'pay_sale_tx_fail'">
                There was an error processing your payment: transaction failed.<br />
                <t t-if="order.payment_tx_id and order.payment_tx_id.state_message">
                    <t t-esc="order.payment_tx_id.state_message"/>
                </t>
            </t>
            <t t-if="error == 'pay_sale_tx_state'">
                There was an error processing your payment: transaction issue.<br />
                <t t-if="order.payment_tx_id and order.payment_tx_id.state_message">
                    <t t-esc="order.payment_tx_id.state_message"/>
                </t>
            </t>
            <t t-if="error == 'pay_sale_tx_confirm'">
                There was an error processing your payment: impossible to validate order.
            </t>
            <t t-if="error == 'pay_sale_tx_token'">
                There was an error processing your payment: issue with credit card ID validation.
            </t>
        </xpath>
    </template>

    <template id="portal_order_success" name="Order success display: payment success"
            inherit_id="sale.portal_order_success">
        <xpath expr="//a[hasclass('close')]" position="after">
            <t t-if="success == 'pay_sale'">
                <span t-if='order.payment_acquirer_id.done_msg' t-raw="order.payment_acquirer_id.done_msg"/>
                <span t-if='order.payment_acquirer_id.post_msg' t-raw="order.payment_acquirer_id.post_msg"/>
            </t>
        </xpath>
    </template>
</odoo>
